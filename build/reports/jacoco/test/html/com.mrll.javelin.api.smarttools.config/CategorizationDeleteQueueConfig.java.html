<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategorizationDeleteQueueConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">smart-tools-events</a> &gt; <a href="index.source.html" class="el_package">com.mrll.javelin.api.smarttools.config</a> &gt; <span class="el_source">CategorizationDeleteQueueConfig.java</span></div><h1>CategorizationDeleteQueueConfig.java</h1><pre class="source lang-java linenums">package com.mrll.javelin.api.smarttools.config;

import com.fasterxml.jackson.databind.JsonMappingException;
import com.mrll.javelin.api.smarttools.exception.FatalSmartSortException;
import com.mrll.javelin.api.smarttools.model.delegates.MetadataUpdateEvent;
import com.mrll.javelin.api.smarttools.service.CategorizationService;
import com.mrll.javelin.api.smarttools.suscriber.CategorizationDeleteExhaustedHandler;
import com.mrll.javelin.api.smarttools.suscriber.CategorizationDeleteMessageFactory;
import com.mrll.javelin.api.smarttools.suscriber.CategorizationDeleteProcessor;
import com.mrll.javelin.api.smarttools.suscriber.CategorizeMetadataValidator;
import com.mrll.javelin.common.event.config.BaseMqConfig;
import com.mrll.javelin.common.event.config.ContainerBuilder;
import com.mrll.javelin.common.event.mq.exhaustion.*;
import com.mrll.javelin.common.security.jwt.JwtConverter;
import com.mrll.javelin.common.security.service.JavelinJwtService;
import com.mrll.javelin.common.security.util.SecurityHelper;
import org.springframework.amqp.core.AmqpAdmin;
import org.springframework.amqp.core.AmqpTemplate;
import org.springframework.amqp.core.MessageListener;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.listener.MessageListenerContainer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class CategorizationDeleteQueueConfig extends BaseMqConfig {

    @Value(&quot;${local-message.metadataEventsExchange}&quot;)
    private String metadataEventsExchange;
    @Value(&quot;${local-message.smartSortDeleteQueue}&quot;)
    private String smartSortDeleteQueue;
    @Value(&quot;${local-message.smartSortDeleteKey}&quot;)
    private String smartSortDeleteKey;

    @Value(&quot;${message.smartSortConsumers: 1}&quot;)
    private int concurrentConsumers;
    @Value(&quot;${message.smartSortMaxConsumers: 3}&quot;)
    private int maxConcurrentConsumers;

    @Value(&quot;${messaging-config.maxRetries: 5}&quot;)
    private int maxRetries;

    private AmqpTemplate amqpTemplate;
    private AmqpAdmin amqpAdmin;

    @Autowired
    private CategorizeMetadataValidator categorizeMetadataValidator;

    public CategorizationDeleteQueueConfig(@Value(&quot;${message.deadLetterExchange}&quot;) String deadLetterExchange,
                                           @Value(&quot;${vcap.application.name:#{null}}&quot;) String cloudFoundryAppName,
                                           @Value(&quot;${spring.application.name:unknown}&quot;) String springAppName,
                                           @Value(&quot;${message.defaultInitiateInterval: 1000}&quot;) long defaultInitiateInterval,
                                           @Value(&quot;${message.defaultInitiateMaxAttempts: 3}&quot;) int defaultInitiateMaxAttempts,
                                           @Value(&quot;${message.defaultInitiateMultiplier: 2.0}&quot;) double defaultInitiateMultiplier,
                                           @Value(&quot;${message.defaultInitiateMaxInterval: 4000}&quot;) long defaultInitiateMaxInterval,
                                           AmqpTemplate amqpTemplate,
                                           AmqpAdmin amqpAdmin) {

<span class="nc" id="L61">        super(deadLetterExchange, cloudFoundryAppName, springAppName, defaultInitiateInterval, defaultInitiateMaxAttempts, defaultInitiateMultiplier, defaultInitiateMaxInterval);</span>

<span class="nc" id="L63">        this.amqpTemplate = amqpTemplate;</span>
<span class="nc" id="L64">        this.amqpAdmin = amqpAdmin;</span>
<span class="nc" id="L65">    }</span>

    @Bean
    public RetryingJavelinMessageListener&lt;MetadataUpdateEvent&gt; deleteFilterListener(JwtConverter jwtConverter,
                                                                                        SecurityHelper securityHelper,
                                                                                        JavelinJwtService jwtService,
                                                                                        MessageProcessor deleteProcessor) {
<span class="nc" id="L72">        return new RetryingJavelinMessageListener&lt;&gt;(jwtConverter,</span>
                securityHelper,
                jwtService,
<span class="nc" id="L75">                maxRetries,</span>
<span class="nc" id="L76">                categorizationDeleteFactory(),</span>
                deleteProcessor,
<span class="nc" id="L78">                categorizationDeleteExhaustedHandler(),</span>
                categorizeMetadataValidator);
    }

    @Bean
    public MessageListenerContainer messageDeleteContainer(ConnectionFactory connectionFactory, MessageListener deleteFilterListener) {
<span class="nc" id="L84">        configureAndDeclareDirectExchangeQueue(amqpAdmin, metadataEventsExchange, smartSortDeleteQueue, smartSortDeleteKey);</span>
<span class="nc" id="L85">        configureAndDeclareDeadLetterQueue(amqpAdmin, smartSortDeleteQueue);</span>

<span class="nc" id="L87">        return new ContainerBuilder()</span>
<span class="nc" id="L88">                .withConnectionFactory(connectionFactory)</span>
<span class="nc" id="L89">                .withQueueName(smartSortDeleteQueue)</span>
<span class="nc" id="L90">                .withMessageListener(deleteFilterListener)</span>
<span class="nc" id="L91">                .withExceptionsToSwallow(FatalSmartSortException.class, JsonMappingException.class, RetriesExhaustedException.class)</span>
<span class="nc" id="L92">                .withConsumerTagStrategy(appNameConsumerTagStrategy())</span>
<span class="nc" id="L93">                .withConcurrentConsumers(concurrentConsumers)</span>
<span class="nc" id="L94">                .withMaxConcurrentConsumers(maxConcurrentConsumers)</span>
<span class="nc" id="L95">                .withAdviceChain(defaultAdviceChain(defaultMessageRecoverer(amqpTemplate,</span>
                        metadataEventsExchange, smartSortDeleteKey, smartSortDeleteQueue)))
<span class="nc" id="L97">                .build();</span>
    }

    @Bean
    public MessageFactory&lt;MetadataUpdateEvent&gt; categorizationDeleteFactory() {
<span class="nc" id="L102">        return new CategorizationDeleteMessageFactory();</span>
    }

    @Bean
    public RetriesExhaustedHandler&lt;MetadataUpdateEvent&gt; categorizationDeleteExhaustedHandler() {
<span class="nc" id="L107">        return new CategorizationDeleteExhaustedHandler();</span>
    }

    @Bean
    public MessageProcessor&lt;MetadataUpdateEvent&gt; deleteProcessor(CategorizationService categorizationService) {
<span class="nc" id="L112">        return new CategorizationDeleteProcessor(categorizationService);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>