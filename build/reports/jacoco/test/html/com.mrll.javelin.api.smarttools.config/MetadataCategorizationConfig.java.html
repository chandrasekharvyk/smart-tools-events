<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetadataCategorizationConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">smart-tools-events</a> &gt; <a href="index.source.html" class="el_package">com.mrll.javelin.api.smarttools.config</a> &gt; <span class="el_source">MetadataCategorizationConfig.java</span></div><h1>MetadataCategorizationConfig.java</h1><pre class="source lang-java linenums">package com.mrll.javelin.api.smarttools.config;

import com.fasterxml.jackson.databind.JsonMappingException;
import com.mrll.javelin.api.smarttools.exception.FatalSmartSortException;
import com.mrll.javelin.api.smarttools.model.delegates.MetadataUpdateEvent;
import com.mrll.javelin.api.smarttools.service.ProjectSettingsService;
import com.mrll.javelin.api.smarttools.service.CategorizationService;
import com.mrll.javelin.api.smarttools.suscriber.CategorizeMetadataExhaustedHandler;
import com.mrll.javelin.api.smarttools.suscriber.CategorizeMetadataMessageFactory;
import com.mrll.javelin.api.smarttools.suscriber.CategorizeMetadataMessageProcessor;
import com.mrll.javelin.api.smarttools.suscriber.CategorizeMetadataValidator;
import com.mrll.javelin.common.event.config.BaseMqConfig;
import com.mrll.javelin.common.event.config.ContainerBuilder;
import com.mrll.javelin.common.event.mq.exhaustion.*;
import com.mrll.javelin.common.security.jwt.JwtConverter;
import com.mrll.javelin.common.security.service.JavelinJwtService;
import com.mrll.javelin.common.security.util.SecurityHelper;
import org.springframework.amqp.core.AmqpAdmin;
import org.springframework.amqp.core.AmqpTemplate;
import org.springframework.amqp.core.MessageListener;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.listener.MessageListenerContainer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MetadataCategorizationConfig extends BaseMqConfig {

    @Value(&quot;${local-message.metadataCategorizationExchange}&quot;)
    private String metadataCategorizationExchange;
    @Value(&quot;${local-message.metadataCategorizationQueue}&quot;)
    private String metadataCategorizationQueue;
    @Value(&quot;${local-message.metadataCategorizationRoutingKey}&quot;)
    private String metadataCategorizationRoutingKey;
    @Value(&quot;${message.smartSortConsumers: 1}&quot;)
    private int concurrentConsumers;
    @Value(&quot;${message.smartSortMaxConsumers: 3}&quot;)
    private int maxConcurrentConsumers;

    @Value(&quot;${messaging-config.maxRetries: 5}&quot;)
    private int maxRetries;

    @Value(&quot;${web-event.smartCategorizationResultExchange}&quot;)
    private String smartCategorizationResultExchange;

    private AmqpTemplate amqpTemplate;
    private AmqpAdmin amqpAdmin;


    public MetadataCategorizationConfig(@Value(&quot;${message.deadLetterExchange}&quot;) String deadLetterExchange,
                                        @Value(&quot;${vcap.application.name:#{null}}&quot;) String cloudFoundryAppName,
                                        @Value(&quot;${spring.application.name:unknown}&quot;) String springAppName,
                                        @Value(&quot;${message.defaultInitiateInterval: 1000}&quot;) long defaultInitiateInterval,
                                        @Value(&quot;${message.defaultInitiateMaxAttempts: 3}&quot;) int defaultInitiateMaxAttempts,
                                        @Value(&quot;${message.defaultInitiateMultiplier: 2.0}&quot;) double defaultInitiateMultiplier,
                                        @Value(&quot;${message.defaultInitiateMaxInterval: 4000}&quot;) long defaultInitiateMaxInterval,
                                        AmqpTemplate amqpTemplate,
                                        AmqpAdmin amqpAdmin) {

<span class="nc" id="L62">        super(deadLetterExchange, cloudFoundryAppName, springAppName, defaultInitiateInterval, defaultInitiateMaxAttempts, defaultInitiateMultiplier, defaultInitiateMaxInterval);</span>
<span class="nc" id="L63">        this.amqpTemplate = amqpTemplate;</span>
<span class="nc" id="L64">        this.amqpAdmin = amqpAdmin;</span>
<span class="nc" id="L65">    }</span>

    @Bean
    public RetryingJavelinMessageListener&lt;MetadataUpdateEvent&gt; eventCategorizationListener(
            JwtConverter jwtConverter,
            SecurityHelper securityHelper,
            JavelinJwtService jwtService,
            MessageProcessor categorizationProcessor) {
<span class="nc" id="L73">        return new RetryingJavelinMessageListener&lt;&gt;(</span>
                jwtConverter,
                securityHelper,
                jwtService,
<span class="nc" id="L77">                maxRetries,</span>
<span class="nc" id="L78">                categorizationFactory(),</span>
                categorizationProcessor,
<span class="nc" id="L80">                categorizationHandler(),</span>
<span class="nc" id="L81">                categorizationValidator());</span>
    }

    @Bean
    public MessageListenerContainer messageCategorizationContainer(ConnectionFactory connectionFactory, MessageListener eventCategorizationListener) {
<span class="nc" id="L86">        configureAndDeclareDirectExchangeQueue(amqpAdmin, metadataCategorizationExchange, metadataCategorizationQueue, metadataCategorizationRoutingKey);</span>
<span class="nc" id="L87">        configureAndDeclareDeadLetterQueue(amqpAdmin, metadataCategorizationRoutingKey);</span>

<span class="nc" id="L89">        return new ContainerBuilder()</span>
<span class="nc" id="L90">                .withConnectionFactory(connectionFactory)</span>
<span class="nc" id="L91">                .withQueueName(metadataCategorizationQueue)</span>
<span class="nc" id="L92">                .withMessageListener(eventCategorizationListener)</span>
<span class="nc" id="L93">                .withExceptionsToSwallow(FatalSmartSortException.class, JsonMappingException.class, RetriesExhaustedException.class)</span>
<span class="nc" id="L94">                .withConsumerTagStrategy(appNameConsumerTagStrategy())</span>
<span class="nc" id="L95">                .withConcurrentConsumers(concurrentConsumers)</span>
<span class="nc" id="L96">                .withMaxConcurrentConsumers(maxConcurrentConsumers)</span>
<span class="nc" id="L97">                .withAdviceChain(defaultAdviceChain(defaultMessageRecoverer(amqpTemplate,</span>
                        metadataCategorizationExchange, metadataCategorizationRoutingKey, metadataCategorizationQueue)))
<span class="nc" id="L99">                .build();</span>
    }

    @Bean
    public MessageValidator&lt;MetadataUpdateEvent&gt; categorizationValidator() {
<span class="nc" id="L104">        return new CategorizeMetadataValidator();</span>
    }

    @Bean
    public MessageProcessor&lt;MetadataUpdateEvent&gt; categorizationProcessor(CategorizationService categorizationService) {
<span class="nc" id="L109">        return new CategorizeMetadataMessageProcessor(categorizationService);</span>
    }

    @Bean
    public MessageFactory&lt;MetadataUpdateEvent&gt; categorizationFactory() {
<span class="nc" id="L114">        return new CategorizeMetadataMessageFactory();</span>
    }

    @Bean
    public RetriesExhaustedHandler&lt;MetadataUpdateEvent&gt; categorizationHandler() {
<span class="nc" id="L119">        return new CategorizeMetadataExhaustedHandler();</span>
    }

    // Ensure result exchange is declared
    @Bean
    public TopicExchange smartCategorizationResultEventExchange() {
<span class="nc" id="L125">        return new TopicExchange(smartCategorizationResultExchange);</span>
    }

    public String getMetadataCategorizationExchange() {
<span class="nc" id="L129">        return metadataCategorizationExchange;</span>
    }

    public String getMetadataCategorizationRoutingKey() {
<span class="nc" id="L133">        return metadataCategorizationRoutingKey;</span>
    }

    /*@Bean
    public ProjectSettingsService getProjectSettingsService(){
        return new ProjectSettingsService();
    }*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>